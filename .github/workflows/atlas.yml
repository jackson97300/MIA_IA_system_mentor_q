name: Repo Atlas

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "**/*.py"
      - ".github/workflows/atlas.yml"
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  generate-atlas:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
      - name: Generate Repository Atlas
        run: |
          echo "🗺️ Generating repository atlas..."
          python tools/repo_atlas.py --root "." --out "reports" --max-depth 10
          
      - name: Upload Atlas Report
        uses: actions/upload-artifact@v4
        with:
          name: repo-atlas
          path: |
            reports/atlas_*.md
            reports/atlas_*.json
          if-no-files-found: ignore
          
      - name: Comment PR with Atlas Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // Find the latest atlas report
              const reportsDir = 'reports';
              const files = fs.readdirSync(reportsDir);
              const atlasFile = files.find(f => f.startsWith('atlas_') && f.endsWith('.md'));
              
              if (atlasFile) {
                const reportPath = path.join(reportsDir, atlasFile);
                const content = fs.readFileSync(reportPath, 'utf8');
                
                // Extract summary section
                const summaryMatch = content.match(/## 📊 Résumé([\s\S]*?)(?=##|$)/);
                const summary = summaryMatch ? summaryMatch[1].trim() : 'Summary not found';
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## 🗺️ Repository Atlas Summary\n\n${summary}\n\n📊 Full report available in artifacts.`
                });
              }
            } catch (error) {
              console.log('Could not generate atlas summary:', error.message);
            }
